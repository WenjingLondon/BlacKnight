<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invest & Redeem</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="invest.css" />
</head>
<body>

<div class="container">
  <!-- å·¦ä¾§ Token åˆ—è¡¨ -->
  <aside class="sidebar">
    <h2>Token List</h2>
    <ul class="token-list">
      <li onclick="selectToken('WBTC')">WBTC</li>
      <li style="color: gray; cursor: not-allowed;">DAIï¼šNot Available Yet</li>
      <li style="color: gray; cursor: not-allowed;">USDCï¼šNot Available Yet</li>
    </ul>
    <li><a href="index.html" style="font-size: 38px; font-weight: bold; color: Green;">Home</a></li>
  </aside>

  <!-- å³ä¾§ä¸»æ“ä½œåŒºåŸŸ -->
  <main class="main-content">
    <h1>Auto Yield</h1>

    <div class="form-block">
      <h3>Invest</h3>
      <input type="text" id="tokenAddress" placeholder="Token Address" />
      <input type="number" id="amount" placeholder="Amount to Invest" />
      <button id="investBtn">Invest</button>
    </div>

    <div class="form-block">
      <h3>Redeem</h3>
      <input type="text" id="redeemTokenAddress" placeholder="Token Address" />
      <input type="number" id="redeemAmount" placeholder="Amount to Redeem" />
      <button id="redeemBtn">Redeem</button>
    </div>

    <p id="status"></p>
  </main>
</div>

<!-- å¼•å…¥ ethers.js & others -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="./config.js"></script>
<script src="./abis/YieldAggregatorV1ABI.js"></script>
<script src="./abis/IStrategy.js"></script>
<script src="./abis/IStrategyManager.js"></script>
<script src="./interaction.js"></script>


<!-- é¡µé¢è„šæœ¬ -->
<script>
  // å®šä¹‰ Token åœ°å€æ˜ å°„
  const TOKEN_ADDRESSES = {
    WBTC: "0x29f2D40B0605204364af54EC677bD022dA425d03"
    // åç»­æ·»åŠ æ›´å¤šæ”¯æŒçš„ token æ—¶ï¼Œåœ¨è¿™é‡Œæ·»åŠ 
  };

  // ç‚¹å‡»å·¦ä¾§ Token æ—¶æ‰§è¡Œ
  window.selectToken = function (symbol) {
    const address = TOKEN_ADDRESSES[symbol];
    if (address) {
      document.getElementById("tokenAddress").value = address;
      document.getElementById("redeemTokenAddress").value = address;

      document.getElementById("amount").value = "";
      document.getElementById("redeemAmount").value = "";

      document.getElementById("status").innerText = `ğŸª™ Selected token: ${symbol}`;
    } else {
      document.getElementById("status").innerText = `âŒ ${symbol} is not available yet.`;
    }
  };

  // å¤„ç†æŠ•èµ„æŒ‰é’®
 document.getElementById("investBtn").addEventListener("click", async () => {
  const token = document.getElementById("tokenAddress").value;
  const amount = document.getElementById("amount").value;

  // ç¡®ä¿ç”¨æˆ·è¾“å…¥äº†ä¸€ä¸ªæœ‰æ•ˆçš„é‡‘é¢
  if (!amount || isNaN(amount) || amount <= 0) {
    document.getElementById("status").innerText = "âŒ Please enter a valid amount.";
    return;
  }

  try {
    // âœ… Step 1ï¼šapprove Aggregator user tokenï¼Œç¡®ä¿æˆæƒé‡‘é¢æ­£ç¡®
    console.log("Approving token...");
    
    // å°†é‡‘é¢è½¬æ¢ä¸ºé€‚åˆçš„å•ä½ï¼ˆå‡è®¾ token ä½¿ç”¨ 18 ä½å°æ•°ï¼‰
    const approveAmount = ethers.utils.parseUnits(amount, 18);
    
    // è°ƒç”¨ approveToken
    await window.interaction.approveToken(token, DEFAULT_AGGREGATOR_ADDRESS, approveAmount);
    console.log("Token approved.");

    // âœ… Step 2ï¼šæ‰§è¡Œå­˜æ¬¾
    console.log("Depositing token...");
    await window.interaction.depositToken(token, amount);
    console.log("Deposit successful.");

    document.getElementById("status").innerText = "âœ… Investment successful!";
  } catch (err) {
    console.error("Error:", err);
    document.getElementById("status").innerText = "âŒ Investment failed.";
  }
});


  // å¤„ç†èµå›æŒ‰é’®
  document.getElementById("redeemBtn").addEventListener("click", async () => {
  const token = document.getElementById("redeemTokenAddress").value;
  const amount = document.getElementById("redeemAmount").value;

  // ç¡®ä¿ç”¨æˆ·è¾“å…¥äº†ä¸€ä¸ªæœ‰æ•ˆçš„é‡‘é¢
  if (!amount || isNaN(amount) || amount <= 0) {
    document.getElementById("status").innerText = "âŒ Please enter a valid redemption amount.";
    return;
  }

  try {
    console.log("Redeeming token...");

    // å°†é‡‘é¢è½¬æ¢ä¸ºæœ€å°å•ä½ï¼ˆå‡è®¾æ˜¯18ä½å°æ•°ï¼‰
    const redeemAmount = ethers.utils.parseUnits(amount, 18);

    // è°ƒç”¨ withdrawToken æ–¹æ³•
    await window.interaction.withdrawToken(token, redeemAmount);
    console.log("Redemption successful.");

    document.getElementById("status").innerText = "âœ… Redemption successful!";

    // æ›´æ–°ä½™é¢
    await updateUserBalance(token);
  } catch (err) {
    console.error("Error:", err);
    document.getElementById("status").innerText = "âŒ Redemption failed.";
  }
});
</script>

</body>
</html>
